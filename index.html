<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Albion Market</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg: #0b0f18;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --accent: #7c5cff;
      --good: #35d07f;
      --bad: #ff5c7a;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 16px;
    }
    [data-theme="light"]{
      --bg: #f6f7fb;
      --card: rgba(255,255,255,.9);
      --card2: rgba(255,255,255,.95);
      --border: rgba(10,15,24,.10);
      --text: rgba(10,15,24,.92);
      --muted: rgba(10,15,24,.65);
      --muted2: rgba(10,15,24,.45);
      --accent: #5b5cff;
      --shadow: 0 18px 50px rgba(10,15,24,.10);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(124,92,255,.25), transparent 60%),
        radial-gradient(900px 700px at 90% 30%, rgba(53,208,127,.18), transparent 60%),
        radial-gradient(900px 700px at 40% 90%, rgba(255,92,122,.14), transparent 60%),
        var(--bg);
      color: var(--text);
    }

    .wrap{ max-width: 1200px; margin: 0 auto; padding: 22px 16px 44px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom: 14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width: 42px; height: 42px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(124,92,255,.9), rgba(53,208,127,.75));
      box-shadow: var(--shadow);
    }
    .title{
      line-height:1.1;
    }
    .title h1{ font-size: 18px; margin:0; letter-spacing:.2px; }
    .title p{ margin:4px 0 0; color: var(--muted); font-size: 12px; }

    .actions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: 0 10px 25px rgba(0,0,0,.12);
      backdrop-filter: blur(10px);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }
    .btn{
      appearance:none; border: 1px solid var(--border); background: var(--card2);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      box-shadow: 0 10px 25px rgba(0,0,0,.10);
      transition: transform .08s ease, background .15s ease;
      font-weight: 600;
      letter-spacing:.2px;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn.primary{
      border: 1px solid rgba(124,92,255,.35);
      background: linear-gradient(135deg, rgba(124,92,255,.85), rgba(124,92,255,.45));
    }
    .btn.ghost{
      background: transparent;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .card .head{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
    }
    [data-theme="light"] .card .head{ border-bottom: 1px solid rgba(10,15,24,.06); }
    .card .head h2{ margin:0; font-size: 14px; letter-spacing: .2px; }
    .card .head .sub{ margin:4px 0 0; font-size: 12px; color: var(--muted); }

    .card .body{ padding: 14px; }

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .form .full{ grid-column: 1 / -1; }
    .field label{
      display:block;
      font-size: 11px;
      color: var(--muted);
      margin: 0 0 6px;
      letter-spacing:.25px;
      text-transform: uppercase;
    }
    .control{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    [data-theme="light"] .control{ background: rgba(255,255,255,.8); }
    .control::placeholder{ color: var(--muted2); }
    select.control{ cursor:pointer; }

    .row-actions{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 10px;
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.12);
      color: var(--muted);
      font-size: 12px;
      width:100%;
      overflow:hidden;
    }
    [data-theme="light"] .pill{ background: rgba(255,255,255,.6); }
    .pill strong{ color: var(--text); }
    .muted{ color: var(--muted); }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .chartWrap{
      position: relative;
      padding: 10px 12px 14px;
    }
    canvas{
      width:100%;
      height: 420px;
      border-radius: 14px;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.08);
      display:block;
    }
    [data-theme="light"] canvas{
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(10,15,24,.08);
    }

    .tooltip{
      position:absolute;
      pointer-events:none;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(10,15,24,.78);
      color: var(--text);
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      font-size: 12px;
      min-width: 180px;
      transform: translate(-50%, -120%);
      opacity: 0;
      transition: opacity .08s ease;
      backdrop-filter: blur(10px);
    }
    [data-theme="light"] .tooltip{ background: rgba(255,255,255,.92); color: rgba(10,15,24,.92); }
    .tooltip .t1{ font-weight:700; margin-bottom: 2px; }
    .tooltip .t2{ color: var(--muted); }

    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
    }
    [data-theme="light"] table{ border: 1px solid rgba(10,15,24,.08); }
    th, td{
      padding: 10px 10px;
      font-size: 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      text-align:left;
      vertical-align: middle;
    }
    [data-theme="light"] th, [data-theme="light"] td{ border-bottom: 1px solid rgba(10,15,24,.06); }
    th{ color: var(--muted); font-weight: 700; font-size: 11px; text-transform: uppercase; letter-spacing:.25px; }
    tr:last-child td{ border-bottom:none; }

    .kpiRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .kpiRow{ grid-template-columns: 1fr; }
    }
    .kpi{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.12);
    }
    [data-theme="light"] .kpi{ background: rgba(255,255,255,.65); }
    .kpi .label{ color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing:.25px; }
    .kpi .value{ font-size: 18px; font-weight: 800; margin-top: 6px; }
    .kpi .hint{ margin-top: 4px; font-size: 12px; color: var(--muted); }
    .good{ color: var(--good); }
    .bad{ color: var(--bad); }

    .watchlist{
      display:flex; flex-direction:column; gap:10px;
    }
    .watchItem{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.10);
    }
    [data-theme="light"] .watchItem{ background: rgba(255,255,255,.62); }
    .watchLeft{ display:flex; flex-direction:column; gap:2px; min-width: 0; }
    .watchLeft .id{ font-weight: 800; font-size: 13px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .watchLeft .meta{ color: var(--muted); font-size: 12px; overflow:hidden; text-overflow: ellipsis; white-space: nowrap; }
    .watchRight{ display:flex; align-items:center; gap:10px; }
    .spark{
      width: 120px; height: 34px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.08);
    }
    [data-theme="light"] .spark{
      border: 1px solid rgba(10,15,24,.10);
      background: rgba(255,255,255,.65);
    }
    .mini{
      font-weight: 800;
      font-size: 13px;
      min-width: 90px;
      text-align:right;
    }
    .iconBtn{
      border: 1px solid var(--border);
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      border-radius: 10px;
      padding: 8px 10px;
      font-weight: 800;
    }
    .iconBtn:hover{ color: var(--text); }

    .small{ font-size: 12px; color: var(--muted); }
    .divider{ height: 1px; background: rgba(255,255,255,.08); margin: 12px 0; }
    [data-theme="light"] .divider{ background: rgba(10,15,24,.08); }

    .err{
      white-space: pre-wrap;
      background: rgba(255,92,122,.12);
      border: 1px solid rgba(255,92,122,.25);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      margin-top:10px;
    }
    .ok{
      white-space: pre-wrap;
      background: rgba(53,208,127,.10);
      border: 1px solid rgba(53,208,127,.20);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      margin-top:10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <h1>Albion Market</h1>
          <p>Stock-style charting for Albion Online Data Project market data</p>
        </div>
      </div>

      <div class="actions">
        <div class="chip" id="clock">—</div>
        <button class="btn ghost" id="themeBtn" title="Toggle theme">Theme</button>
        <button class="btn" id="refreshBtn" title="Reload current selection">Refresh</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left panel -->
      <div class="card">
        <div class="head">
          <div>
            <h2>Controls</h2>
            <div class="sub">Pick item + market, then load.</div>
          </div>
        </div>

        <div class="body">
          <div class="form">
            <div class="field">
              <label>Server</label>
              <select class="control" id="region">
                <option value="west" selected>West</option>
                <option value="east">East</option>
                <option value="europe">Europe</option>
              </select>
            </div>

            <div class="field">
              <label>City</label>
              <select class="control" id="city">
                <option>Caerleon</option>
                <option>Thetford</option>
                <option>Lymhurst</option>
                <option>Bridgewatch</option>
                <option>Martlock</option>
                <option>Fort Sterling</option>
                <option>Brecilien</option>
              </select>
            </div>

            <div class="field full">
              <label>Item ID</label>
              <input class="control" id="item" placeholder="e.g. T4_BAG, T6_PLANKS" value="T4_BAG" />
            </div>

            <div class="field">
              <label>Quality</label>
              <select class="control" id="quality">
                <option value="1" selected>1 (Normal)</option>
                <option value="2">2 (Good)</option>
                <option value="3">3 (Outstanding)</option>
                <option value="4">4 (Excellent)</option>
                <option value="5">5 (Masterpiece)</option>
                <option value="0">0 (Any)</option>
              </select>
            </div>

            <div class="field">
              <label>Time-scale</label>
              <select class="control" id="scale">
                <option value="1">1h</option>
                <option value="6">6h</option>
                <option value="24" selected>24h</option>
                <option value="168">7d</option>
              </select>
            </div>

            <div class="field full">
              <label>Auto refresh</label>
              <select class="control" id="autoRefresh">
                <option value="0" selected>Off</option>
                <option value="60">Every 1 min</option>
                <option value="300">Every 5 min</option>
                <option value="900">Every 15 min</option>
                <option value="1800">Every 30 min</option>
              </select>
            </div>
          </div>

          <div class="row-actions">
            <button class="btn primary" id="loadBtn">Load</button>
            <button class="btn" id="addWatchBtn" title="Add current selection to watchlist">Add to Watchlist</button>
            <button class="btn ghost" id="clearWatchBtn" title="Clear watchlist">Clear Watchlist</button>
          </div>

          <div id="ok" class="ok"></div>
          <div id="err" class="err"></div>

          <div class="divider"></div>

          <div class="split">
            <div class="pill">
              <span class="muted">Selection:</span>
              <strong id="selText">—</strong>
            </div>

            <div class="watchlist" id="watchlist"></div>

            <div class="small" id="hint">
              Tip: Use the watchlist as your “ticker board” for crafting materials and finished goods.
            </div>
          </div>
        </div>
      </div>

      <!-- Right panel -->
      <div class="card">
        <div class="head">
          <div>
            <h2>Chart</h2>
            <div class="sub" id="chartSub">Avg price history (sell) + snapshot</div>
          </div>
        </div>

        <div class="chartWrap">
          <canvas id="chart" width="1400" height="540" aria-label="Price chart" role="img"></canvas>
          <div class="tooltip" id="tip">
            <div class="t1" id="tipT1">—</div>
            <div class="t2" id="tipT2">—</div>
          </div>

          <div class="kpiRow">
            <div class="kpi">
              <div class="label">Current Sell Min</div>
              <div class="value" id="kSell">—</div>
              <div class="hint" id="kSellD">—</div>
            </div>
            <div class="kpi">
              <div class="label">Current Buy Max</div>
              <div class="value" id="kBuy">—</div>
              <div class="hint" id="kBuyD">—</div>
            </div>
            <div class="kpi">
              <div class="label">Trend (history)</div>
              <div class="value" id="kTrend">—</div>
              <div class="hint" id="kTrendD">—</div>
            </div>
          </div>

          <div class="divider"></div>

          <table>
            <thead>
              <tr>
                <th>Item</th><th>City</th><th>Quality</th>
                <th>Sell Min</th><th>Sell Min Date</th>
                <th>Buy Max</th><th>Buy Max Date</th>
              </tr>
            </thead>
            <tbody id="snap"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);

  function baseUrl(region) {
    const r = (region || "west").toLowerCase();
    if (r === "east") return "https://east.albion-online-data.com";
    if (r === "europe") return "https://europe.albion-online-data.com";
    return "https://west.albion-online-data.com";
  }

  async function fetchJson(url) {
    const res = await fetch(url, { headers: { "Accept": "application/json" } });
    if (!res.ok) {
      const t = await res.text().catch(() => "");
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${t.slice(0, 250)}`);
    }
    return await res.json();
  }

  function fmt(n) {
    if (n === null || n === undefined || n === "") return "—";
    const v = Number(n);
    if (!Number.isFinite(v)) return "—";
    return v.toLocaleString();
  }

  function dt(s) {
    if (!s) return "—";
    try {
      const d = new Date(s);
      if (isNaN(d.getTime())) return String(s).replace("T"," ").replace("Z","");
      return d.toLocaleString();
    } catch { return String(s); }
  }

  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  function setTheme(theme) {
    document.documentElement.setAttribute("data-theme", theme);
    localStorage.setItem("theme", theme);
  }

  function getTheme() {
    return localStorage.getItem("theme") || (matchMedia("(prefers-color-scheme: light)").matches ? "light" : "dark");
  }

  function toastOK(msg) {
    $("ok").style.display = "block";
    $("ok").textContent = msg;
    setTimeout(() => { $("ok").style.display = "none"; }, 2500);
  }

  function showErr(msg) {
    $("err").style.display = "block";
    $("err").textContent = msg;
  }

  function clearErr() {
    $("err").style.display = "none";
    $("err").textContent = "";
  }

  function nowClock() {
    $("clock").textContent = new Date().toLocaleString();
  }

  // ---------- Chart ----------
  const chartState = { points: [], meta: null };

  function drawChart(points, meta) {
    const canvas = $("chart");
    const ctx = canvas.getContext("2d");
    const W = canvas.width, H = canvas.height;

    ctx.clearRect(0,0,W,H);

    // plot region
    const padL = 72, padR = 18, padT = 18, padB = 46;
    const plotW = W - padL - padR;
    const plotH = H - padT - padB;

    // background grid
    const isLight = (document.documentElement.getAttribute("data-theme") === "light");
    ctx.fillStyle = isLight ? "rgba(255,255,255,.0)" : "rgba(0,0,0,.0)";
    ctx.fillRect(0,0,W,H);

    if (!points.length) {
      ctx.fillStyle = isLight ? "rgba(10,15,24,.65)" : "rgba(255,255,255,.65)";
      ctx.font = "14px system-ui";
      ctx.fillText("No history data for this selection.", padL, padT + 24);
      return;
    }

    const xs = points.map(p => p.t);
    const ys = points.map(p => p.v);

    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);

    const xScale = (x) => padL + ((x - minX) / (maxX - minX || 1)) * plotW;
    const yScale = (y) => padT + (1 - ((y - minY) / (maxY - minY || 1))) * plotH;

    // grid + y labels
    ctx.font = "12px system-ui";
    ctx.fillStyle = isLight ? "rgba(10,15,24,.65)" : "rgba(255,255,255,.65)";
    for (let i = 0; i <= 5; i++) {
      const yVal = minY + ((maxY - minY) * (i/5));
      const y = yScale(yVal);
      ctx.strokeStyle = isLight ? "rgba(10,15,24,.08)" : "rgba(255,255,255,.08)";
      ctx.beginPath();
      ctx.moveTo(padL, y);
      ctx.lineTo(W - padR, y);
      ctx.stroke();
      ctx.fillText(fmt(yVal.toFixed(0)), 10, y + 4);
    }

    // x labels (3 ticks)
    ctx.fillStyle = isLight ? "rgba(10,15,24,.55)" : "rgba(255,255,255,.55)";
    const t1 = new Date(minX);
    const t2 = new Date((minX + maxX) / 2);
    const t3 = new Date(maxX);
    const xsTicks = [
      { x: padL, label: t1.toLocaleDateString() },
      { x: padL + plotW/2, label: t2.toLocaleDateString() },
      { x: padL + plotW, label: t3.toLocaleDateString() },
    ];
    xsTicks.forEach(tt => {
      ctx.fillText(tt.label, tt.x - 26, H - 18);
    });

    // axes
    ctx.strokeStyle = isLight ? "rgba(10,15,24,.16)" : "rgba(255,255,255,.16)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, H - padB);
    ctx.lineTo(W - padR, H - padB);
    ctx.stroke();

    // line + gradient area
    const grad = ctx.createLinearGradient(0, padT, 0, H - padB);
    grad.addColorStop(0, "rgba(124,92,255,.35)");
    grad.addColorStop(1, "rgba(124,92,255,0)");
    ctx.fillStyle = grad;

    ctx.beginPath();
    points.forEach((p, i) => {
      const x = xScale(p.t);
      const y = yScale(p.v);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.lineTo(xScale(points[points.length - 1].t), H - padB);
    ctx.lineTo(xScale(points[0].t), H - padB);
    ctx.closePath();
    ctx.fill();

    ctx.strokeStyle = "rgba(124,92,255,.95)";
    ctx.lineWidth = 2.2;
    ctx.beginPath();
    points.forEach((p, i) => {
      const x = xScale(p.t);
      const y = yScale(p.v);
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });
    ctx.stroke();

    // last point marker
    const last = points[points.length - 1];
    const lx = xScale(last.t), ly = yScale(last.v);
    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.beginPath(); ctx.arc(lx, ly, 3.6, 0, Math.PI*2); ctx.fill();
    ctx.strokeStyle = "rgba(124,92,255,.95)";
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(lx, ly, 6.5, 0, Math.PI*2); ctx.stroke();

    // store state for tooltip
    chartState.points = points;
    chartState.meta = { minX, maxX, minY, maxY, padL, padR, padT, padB, plotW, plotH, xScale, yScale };
  }

  function setupTooltip() {
    const canvas = $("chart");
    const tip = $("tip");
    const t1 = $("tipT1");
    const t2 = $("tipT2");

    function hide() { tip.style.opacity = "0"; }

    canvas.addEventListener("mouseleave", hide);
    canvas.addEventListener("mousemove", (e) => {
      if (!chartState.points.length || !chartState.meta) return hide();

      const rect = canvas.getBoundingClientRect();
      const mx = (e.clientX - rect.left) * (canvas.width / rect.width);
      const my = (e.clientY - rect.top) * (canvas.height / rect.height);

      const m = chartState.meta;
      const xIn = clamp(mx, m.padL, m.padL + m.plotW);

      // nearest point by x
      const targetT = m.minX + ((xIn - m.padL) / (m.plotW || 1)) * (m.maxX - m.minX);
      let best = 0;
      for (let i=1;i<chartState.points.length;i++){
        if (Math.abs(chartState.points[i].t - targetT) < Math.abs(chartState.points[best].t - targetT)) best = i;
      }
      const p = chartState.points[best];
      const px = m.xScale(p.t);
      const py = m.yScale(p.v);

      // draw crosshair overlay
      const ctx = canvas.getContext("2d");
      drawChart(chartState.points, null);

      ctx.strokeStyle = "rgba(255,255,255,.20)";
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(px, m.padT); ctx.lineTo(px, canvas.height - m.padB); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(m.padL, py); ctx.lineTo(canvas.width - m.padR, py); ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.95)";
      ctx.beginPath(); ctx.arc(px, py, 3.6, 0, Math.PI*2); ctx.fill();

      t1.textContent = `${fmt(p.v)} avg`;
      t2.textContent = new Date(p.t).toLocaleString();

      tip.style.left = (px * (rect.width / canvas.width)) + "px";
      tip.style.top  = (py * (rect.height / canvas.height)) + "px";
      tip.style.opacity = "1";
    });
  }

  // ---------- Watchlist ----------
  const WATCH_KEY = "albion_watchlist_v1";

  function getWatchlist() {
    try {
      const raw = localStorage.getItem(WATCH_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch { return []; }
  }

  function setWatchlist(list) {
    localStorage.setItem(WATCH_KEY, JSON.stringify(list));
    renderWatchlist();
  }

  function watchKeyOf(w) {
    return `${w.region}|${w.city}|${w.quality}|${w.scale}|${w.item}`;
  }

  function currentSelection() {
    return {
      region: $("region").value,
      city: $("city").value,
      quality: $("quality").value,
      scale: $("scale").value,
      item: $("item").value.trim()
    };
  }

  async function loadSpark(w) {
    const base = baseUrl(w.region);
    const historyUrl = `${base}/api/v2/stats/history/${encodeURIComponent(w.item)}.json?locations=${encodeURIComponent(w.city)}&qualities=${encodeURIComponent(w.quality)}&time-scale=${encodeURIComponent(w.scale)}`;
    const hist = await fetchJson(historyUrl);

    const series = (hist && hist[0] && hist[0].data) ? hist[0].data : [];
    const pts = series
      .filter(pt => pt && pt.timestamp && (pt.avg_price || pt.avg_price === 0))
      .map(pt => ({ t: new Date(pt.timestamp).getTime(), v: Number(pt.avg_price) }))
      .sort((a,b) => a.t - b.t);

    return pts;
  }

  function sparkSvg(points) {
    if (!points.length) return `<svg class="spark" viewBox="0 0 120 34" preserveAspectRatio="none"></svg>`;
    const w = 120, h = 34, pad = 3;
    const xs = points.map(p => p.t);
    const ys = points.map(p => p.v);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const x = (t) => pad + ((t - minX) / (maxX - minX || 1)) * (w - pad*2);
    const y = (v) => pad + (1 - ((v - minY) / (maxY - minY || 1))) * (h - pad*2);
    let d = "";
    points.forEach((p, i) => d += (i===0 ? "M" : "L") + x(p.t).toFixed(2) + "," + y(p.v).toFixed(2));
    return `
      <svg class="spark" viewBox="0 0 120 34" preserveAspectRatio="none">
        <path d="${d}" fill="none" stroke="rgba(124,92,255,.95)" stroke-width="2" />
      </svg>
    `;
  }

  function renderWatchlist() {
    const list = getWatchlist();
    const host = $("watchlist");
    host.innerHTML = "";

    if (!list.length) {
      host.innerHTML = `<div class="pill"><span class="muted">Watchlist:</span> <strong>Empty</strong></div>`;
      return;
    }

    list.forEach((w) => {
      const div = document.createElement("div");
      div.className = "watchItem";
      div.innerHTML = `
        <div class="watchLeft" title="${w.item}">
          <div class="id">${w.item}</div>
          <div class="meta">${w.region.toUpperCase()} • ${w.city} • Q${w.quality} • ${w.scale}h</div>
        </div>
        <div class="watchRight">
          <div class="mini" id="mini_${watchKeyOf(w).replaceAll('|','_')}">—</div>
          <div id="spark_${watchKeyOf(w).replaceAll('|','_')}">${sparkSvg([])}</div>
          <button class="iconBtn" title="Load this" data-load="${watchKeyOf(w)}">Load</button>
          <button class="iconBtn" title="Remove" data-del="${watchKeyOf(w)}">✕</button>
        </div>
      `;
      host.appendChild(div);
    });

    host.querySelectorAll("[data-load]").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-load");
        const w = getWatchlist().find(x => watchKeyOf(x) === key);
        if (!w) return;
        $("region").value = w.region;
        $("city").value = w.city;
        $("quality").value = w.quality;
        $("scale").value = w.scale;
        $("item").value = w.item;
        loadMain();
      });
    });

    host.querySelectorAll("[data-del]").forEach(btn => {
      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-del");
        const next = getWatchlist().filter(x => watchKeyOf(x) !== key);
        setWatchlist(next);
      });
    });

    // refresh sparklines + mini prices (best-effort)
    list.forEach(async (w) => {
      try {
        const pts = await loadSpark(w);
        const last = pts.length ? pts[pts.length - 1].v : null;
        const miniId = "mini_" + watchKeyOf(w).replaceAll("|","_");
        const sparkId = "spark_" + watchKeyOf(w).replaceAll("|","_");
        const elMini = $(miniId);
        const elSpark = $(sparkId);
        if (elMini) elMini.textContent = last === null ? "—" : fmt(last);
        if (elSpark) elSpark.innerHTML = sparkSvg(pts.slice(Math.max(0, pts.length - 40)));
      } catch {
        // silent: watchlist should stay responsive even if one item fails
      }
    });
  }

  // ---------- Main loader ----------
  let autoTimer = null;

  async function loadMain() {
    clearErr();

    const sel = currentSelection();
    if (!sel.item) {
      showErr("Enter an Item ID (example: T4_BAG).");
      return;
    }

    $("selText").textContent = `${sel.item} • ${sel.region.toUpperCase()} • ${sel.city} • Q${sel.quality} • ${sel.scale}h`;
    $("chartSub").textContent = `Avg price history (sell) • ${sel.city} • Q${sel.quality} • ${sel.scale}h`;

    const base = baseUrl(sel.region);

    const pricesUrl =
      `${base}/api/v2/stats/prices/${encodeURIComponent(sel.item)}.json` +
      `?locations=${encodeURIComponent(sel.city)}` +
      `&qualities=${encodeURIComponent(sel.quality)}`;

    const historyUrl =
      `${base}/api/v2/stats/history/${encodeURIComponent(sel.item)}.json` +
      `?locations=${encodeURIComponent(sel.city)}` +
      `&qualities=${encodeURIComponent(sel.quality)}` +
      `&time-scale=${encodeURIComponent(sel.scale)}`;

    // Loading state
    $("loadBtn").textContent = "Loading…";
    $("loadBtn").disabled = true;

    try {
      const [hist, snap] = await Promise.all([fetchJson(historyUrl), fetchJson(pricesUrl)]);

      // history points
      const series = (hist && hist[0] && hist[0].data) ? hist[0].data : [];
      const points = series
        .filter(pt => pt && pt.timestamp && (pt.avg_price || pt.avg_price === 0))
        .map(pt => ({ t: new Date(pt.timestamp).getTime(), v: Number(pt.avg_price) }))
        .sort((a,b) => a.t - b.t);

      drawChart(points, null);

      // snapshot table + KPIs
      const tbody = $("snap");
      tbody.innerHTML = "";

      let sellMin = null, sellDate = null, buyMax = null, buyDate = null;
      (snap || []).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.item_id || ""}</td>
          <td>${r.city || ""}</td>
          <td>${r.quality ?? ""}</td>
          <td>${fmt(r.sell_price_min)}</td>
          <td>${dt(r.sell_price_min_date)}</td>
          <td>${fmt(r.buy_price_max)}</td>
          <td>${dt(r.buy_price_max_date)}</td>
        `;
        tbody.appendChild(tr);

        sellMin = r.sell_price_min;
        sellDate = r.sell_price_min_date;
        buyMax = r.buy_price_max;
        buyDate = r.buy_price_max_date;
      });

      $("kSell").textContent = fmt(sellMin);
      $("kSellD").textContent = dt(sellDate);
      $("kBuy").textContent = fmt(buyMax);
      $("kBuyD").textContent = dt(buyDate);

      // trend
      if (points.length >= 2) {
        const first = points[0].v;
        const last = points[points.length - 1].v;
        const chg = last - first;
        const pct = first ? (chg / first) * 100 : 0;
        const arrow = chg >= 0 ? "▲" : "▼";
        $("kTrend").textContent = `${arrow} ${fmt(Math.abs(chg).toFixed(0))}`;
        $("kTrend").className = "value " + (chg >= 0 ? "good" : "bad");
        $("kTrendD").textContent = `${pct.toFixed(1)}% from first point`;
      } else {
        $("kTrend").textContent = "—";
        $("kTrend").className = "value";
        $("kTrendD").textContent = "Not enough history points";
      }

      toastOK(`Loaded: ${points.length} history points`);
      renderWatchlist(); // refresh watchlist minis
    } catch (e) {
      showErr(
        "Error loading market data.\n\n" +
        String(e) +
        "\n\nIf this works on GitHub Pages but fails on a corporate network, it may be blocked by firewall policy."
      );
    } finally {
      $("loadBtn").textContent = "Load";
      $("loadBtn").disabled = false;
    }
  }

  function updateAutoRefresh() {
    if (autoTimer) { clearInterval(autoTimer); autoTimer = null; }
    const secs = Number($("autoRefresh").value || 0);
    if (secs > 0) {
      autoTimer = setInterval(() => loadMain(), secs * 1000);
    }
  }

  function addToWatchlist() {
    clearErr();
    const sel = currentSelection();
    if (!sel.item) { showErr("Enter an Item ID first."); return; }
    const list = getWatchlist();
    const key = watchKeyOf(sel);
    if (list.some(x => watchKeyOf(x) === key)) {
      toastOK("Already in watchlist.");
      return;
    }
    list.unshift(sel);
    setWatchlist(list.slice(0, 20)); // keep it sane
    toastOK("Added to watchlist.");
  }

  // ---------- Init ----------
  function init() {
    // theme
    setTheme(getTheme());
    $("themeBtn").addEventListener("click", () => {
      const cur = document.documentElement.getAttribute("data-theme") || "dark";
      setTheme(cur === "dark" ? "light" : "dark");
      // redraw chart for grid contrast
      if (chartState.points.length) drawChart(chartState.points, null);
    });

    // clock
    nowClock();
    setInterval(nowClock, 1000);

    // handlers
    $("loadBtn").addEventListener("click", loadMain);
    $("refreshBtn").addEventListener("click", loadMain);
    $("addWatchBtn").addEventListener("click", addToWatchlist);
    $("clearWatchBtn").addEventListener("click", () => { setWatchlist([]); toastOK("Watchlist cleared."); });
    $("autoRefresh").addEventListener("change", updateAutoRefresh);

    // enter-to-load
    $("item").addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadMain();
    });

    setupTooltip();
    renderWatchlist();

    // initial selection text
    const sel = currentSelection();
    $("selText").textContent = `${sel.item} • ${sel.region.toUpperCase()} • ${sel.city} • Q${sel.quality} • ${sel.scale}h`;
    updateAutoRefresh();
  }

  init();
</script>
</body>
</html>
